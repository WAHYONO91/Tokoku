-- DB schema & seed
CREATE DATABASE IF NOT EXISTS tokoapp CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
USE tokoapp;
CREATE TABLE IF NOT EXISTS users(id INT AUTO_INCREMENT PRIMARY KEY,username VARCHAR(50) UNIQUE,password_hash VARCHAR(255),role ENUM('admin','kasir') DEFAULT 'kasir',is_active TINYINT DEFAULT 1,created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP);
CREATE TABLE IF NOT EXISTS settings(id INT PRIMARY KEY,store_name VARCHAR(120) DEFAULT 'TOKO',store_address VARCHAR(255) DEFAULT '',store_phone VARCHAR(50) DEFAULT '',footer_note VARCHAR(255) DEFAULT 'Terima kasih telah berbelanja.',logo_url VARCHAR(255) DEFAULT '',invoice_prefix VARCHAR(32) DEFAULT 'INV/',invoice_counter_date DATE NULL,invoice_counter INT DEFAULT 0,points_per_rupiah INT DEFAULT 0,qr_provider_url VARCHAR(255) DEFAULT 'https://api.qrserver.com/v1/create-qr-code/?size=140x140&data=');
INSERT INTO settings(id) VALUES(1) ON DUPLICATE KEY UPDATE id=id;
CREATE TABLE IF NOT EXISTS units(code VARCHAR(16) PRIMARY KEY,name VARCHAR(32) NOT NULL);
INSERT IGNORE INTO units(code,name) VALUES('pcs','Pieces'),('kg','Kilogram'),('gr','Gram'),('liter','Liter'),('ml','Mililiter'),('dus','Dus');
CREATE TABLE IF NOT EXISTS locations(code VARCHAR(32) PRIMARY KEY,name VARCHAR(64)); INSERT IGNORE INTO locations(code,name) VALUES('gudang','Gudang'),('toko','Toko');
CREATE TABLE IF NOT EXISTS items(kode VARCHAR(64) PRIMARY KEY,barcode VARCHAR(64) UNIQUE NULL,nama VARCHAR(160) NOT NULL,unit_code VARCHAR(16) NOT NULL DEFAULT 'pcs',harga_beli BIGINT DEFAULT 0,harga_jual1 BIGINT DEFAULT 0,harga_jual2 BIGINT DEFAULT 0,harga_jual3 BIGINT DEFAULT 0,harga_jual4 BIGINT DEFAULT 0,min_stock INT DEFAULT 0,created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,updated_at TIMESTAMP NULL);
CREATE TABLE IF NOT EXISTS item_stocks(item_kode VARCHAR(64),location VARCHAR(32),qty INT DEFAULT 0,PRIMARY KEY(item_kode,location));
CREATE TABLE IF NOT EXISTS members(id INT AUTO_INCREMENT PRIMARY KEY,kode VARCHAR(64) UNIQUE,nama VARCHAR(160),alamat VARCHAR(255) DEFAULT '',tlp VARCHAR(64) DEFAULT '',poin INT DEFAULT 0,created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP);
CREATE TABLE IF NOT EXISTS suppliers(id INT AUTO_INCREMENT PRIMARY KEY,kode VARCHAR(64) UNIQUE,nama VARCHAR(160),alamat VARCHAR(255) DEFAULT '',tlp VARCHAR(64) DEFAULT '',created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP);
CREATE TABLE IF NOT EXISTS purchases(id INT AUTO_INCREMENT PRIMARY KEY,supplier_kode VARCHAR(64) NULL,location VARCHAR(32) DEFAULT 'gudang',subtotal BIGINT DEFAULT 0,discount BIGINT DEFAULT 0,tax BIGINT DEFAULT 0,total BIGINT DEFAULT 0,created_by VARCHAR(64),status ENUM('OK','VOID') DEFAULT 'OK',void_reason VARCHAR(255) NULL,void_by VARCHAR(64) NULL,void_at DATETIME NULL,created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP);
CREATE TABLE IF NOT EXISTS purchase_items(id INT AUTO_INCREMENT PRIMARY KEY,purchase_id INT,item_kode VARCHAR(64),nama VARCHAR(160),qty INT,harga BIGINT DEFAULT 0);
CREATE TABLE IF NOT EXISTS sales(id INT AUTO_INCREMENT PRIMARY KEY,invoice_no VARCHAR(64) UNIQUE,member_kode VARCHAR(64) NULL,shift ENUM('1','2') DEFAULT '1',subtotal BIGINT DEFAULT 0,discount BIGINT DEFAULT 0,tax BIGINT DEFAULT 0,total BIGINT DEFAULT 0,tunai BIGINT DEFAULT 0,kembalian BIGINT DEFAULT 0,created_by VARCHAR(64),payment_method VARCHAR(32) DEFAULT 'TUNAI',payment_ref VARCHAR(64) DEFAULT '',status ENUM('OK','VOID') DEFAULT 'OK',void_reason VARCHAR(255) NULL,void_by VARCHAR(64) NULL,void_at DATETIME NULL,created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP);
CREATE TABLE IF NOT EXISTS sale_items(id INT AUTO_INCREMENT PRIMARY KEY,sale_id INT,item_kode VARCHAR(64),nama VARCHAR(160),qty INT,harga BIGINT DEFAULT 0,discount_item BIGINT DEFAULT 0,tax_item BIGINT DEFAULT 0);
-- admin / admin123
INSERT INTO users(username,password_hash,role,is_active) VALUES('admin','$2y$10$jlSV1x/vZQb1Phk6lqUfF.NGh2Yk1rQeKMTy2w1mEHINulwEzGutS','admin',1) ON DUPLICATE KEY UPDATE username=username;
